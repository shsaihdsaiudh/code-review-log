
# OpenAi ä»£ç è¯„å®¡.
### ğŸ˜€ä»£ç è¯„åˆ†ï¼š35
#### ğŸ˜€ä»£ç é€»è¾‘ä¸ç›®çš„ï¼š
è¿™ä¸¤ä¸ªæµ‹è¯•ç±»æ—¨åœ¨æ¨¡æ‹Ÿå’Œæµ‹è¯•ä»£ç è¯„å®¡ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ã€‚LocalTestç”¨äºæœ¬åœ°ç¯å¢ƒä¸‹çš„å®Œæ•´æµç¨‹æµ‹è¯•ï¼Œé€šè¿‡åŒ¿åç±»é‡å†™æ–¹æ³•æ¥æ¨¡æ‹Ÿgit diffæ•°æ®ï¼›PushTestä¸“æ³¨äºéªŒè¯ä»£ç è¯„å®¡æ—¥å¿—çš„æ¨é€åŠŸèƒ½ï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿå°†è¯„å®¡ç»“æœæ­£ç¡®æäº¤åˆ°è¿œç¨‹ä»“åº“ã€‚
#### âœ…ä»£ç ä¼˜ç‚¹ï¼š
1. æä¾›äº†å®Œæ•´çš„æœ¬åœ°æµ‹è¯•ç¯å¢ƒï¼Œä¾¿äºå¼€å‘è°ƒè¯•
2. å®ç°äº†ç¯å¢ƒå˜é‡ä¸é»˜è®¤å€¼çš„ä¼˜é›…é™çº§æœºåˆ¶
3. æ—¥å¿—è®°å½•å®Œå–„ï¼Œä¾¿äºé—®é¢˜è¿½è¸ª
4. æµ‹è¯•è¦†ç›–äº†æ ¸å¿ƒä¸šåŠ¡æµç¨‹
#### ğŸ¤”é—®é¢˜ç‚¹ï¼š
1. **ä¸¥é‡å®‰å…¨æ¼æ´**ï¼šGitHub tokenã€å¾®ä¿¡å¯†é’¥ã€APIå¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯ç¡¬ç¼–ç åœ¨æºä»£ç ä¸­ï¼Œå­˜åœ¨æå¤§çš„å®‰å…¨é£é™©
2. **æµ‹è¯•æ•°æ®æ±¡æŸ“**ï¼šä½¿ç”¨ç¡¬ç¼–ç çš„çœŸå®ä»“åº“åœ°å€å’Œtokenï¼Œå¯èƒ½å½±å“ç”Ÿäº§ç¯å¢ƒ
3. **å¼‚å¸¸å¤„ç†ä¸å½“**ï¼šä½¿ç”¨è¿‡äºå®½æ³›çš„Exceptionæ•è·ï¼Œæ©ç›–äº†å…·ä½“é”™è¯¯ä¿¡æ¯
4. **ä»£ç è§„èŒƒé—®é¢˜**ï¼šæµ‹è¯•ç±»å’Œæ–¹æ³•å‘½åä¸å¤Ÿæ¸…æ™°ï¼Œå­˜åœ¨å ä½ç¬¦æœªæ›¿æ¢
5. **æ—¥æœŸå¼‚å¸¸**ï¼šæ³¨é‡Šä¸­çš„åˆ›å»ºæ—¥æœŸä¸ºæœªæ¥æ—¶é—´ï¼ˆ2025-12-18ï¼‰
6. **æµ‹è¯•éš”ç¦»æ€§å·®**ï¼šæµ‹è¯•æ–¹æ³•ä¹‹é—´å­˜åœ¨ä¾èµ–ï¼Œä¸”å¯èƒ½å½±å“çœŸå®æ•°æ®
#### ğŸ¯ä¿®æ”¹å»ºè®®ï¼š
1. ç«‹å³ç§»é™¤æ‰€æœ‰ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯ï¼Œæ”¹ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶
2. ä½¿ç”¨mockå¯¹è±¡æ›¿ä»£çœŸå®çš„è¿œç¨‹æœåŠ¡è°ƒç”¨
3. ç»†åŒ–å¼‚å¸¸å¤„ç†ï¼Œé’ˆå¯¹ä¸åŒå¼‚å¸¸ç±»å‹é‡‡å–ç›¸åº”æªæ–½
4. è§„èŒƒå‘½åï¼Œä½¿ç”¨æ›´å…·æè¿°æ€§çš„æµ‹è¯•æ–¹æ³•å
5. ä¿®æ­£æ—¥æœŸä¿¡æ¯ï¼Œä½¿ç”¨å ä½ç¬¦æ¨¡æ¿
6. æ·»åŠ æµ‹è¯•æ•°æ®æ¸…ç†æœºåˆ¶ï¼Œç¡®ä¿æµ‹è¯•ç‹¬ç«‹æ€§
7. ä½¿ç”¨@Testæ³¨è§£çš„descriptionå±æ€§è¯´æ˜æµ‹è¯•ç›®çš„
#### ğŸ’»ä¿®æ”¹åçš„ä»£ç ï¼š
```java
package com.microsoft;

import com.microsoft.domain.service.impl.OpenAICodeReviewService;
import com.microsoft.infrastruture.git.GitCommand;
import com.microsoft.infrastruture.openai.IOpenAI;
import com.microsoft.infrastruture.openai.impl.ChatGLM;
import com.microsoft.infrastruture.weixin.WeiXin;
import lombok.extern.slf4j.Slf4j;
import org.junit.Test;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;

import static org.mockito.Mockito.when;

/**
 * æœ¬åœ°ä»£ç è¯„å®¡æµç¨‹æµ‹è¯•ç±»
 * 
 * @author development-team
 * @create ${CURRENT_DATE}
 * 
 * ç”¨äºåœ¨æœ¬åœ°ç¯å¢ƒä¸­æµ‹è¯•ä»£ç è¯„å®¡çš„æ ¸å¿ƒæµç¨‹ï¼Œä½¿ç”¨mockæ•°æ®é¿å…çœŸå®ä¾èµ–
 */
@Slf4j
public class LocalCodeReviewFlowTest {

    @Mock
    private IOpenAI mockOpenAI;
    
    @Mock
    private GitCommand mockGitCommand;
    
    @Mock
    private WeiXin mockWeiXin;

    @Test
    public void shouldExecuteCodeReviewFlowWithMockData() {
        MockitoAnnotations.initMocks(this);
        
        try {
            // é…ç½®mockå¯¹è±¡
            when(mockGitCommand.getDiffCode()).thenReturn(getTestDiffData());
            
            // åˆ›å»ºæœåŠ¡å®ä¾‹
            OpenAICodeReviewService service = new OpenAICodeReviewService(
                mockOpenAI, 
                mockGitCommand, 
                mockWeiXin
            );
            
            // æ‰§è¡Œæµ‹è¯•
            service.exec();
            
            log.info("ä»£ç è¯„å®¡æµç¨‹æµ‹è¯•æ‰§è¡Œå®Œæˆ");
        } catch (IllegalStateException e) {
            log.error("æ— æ•ˆçŠ¶æ€å¯¼è‡´æµ‹è¯•å¤±è´¥: {}", e.getMessage());
            throw e;
        } catch (RuntimeException e) {
            log.error("è¿è¡Œæ—¶å¼‚å¸¸: {}", e.getMessage());
            throw e;
        }
    }

    /**
     * è·å–æµ‹è¯•ç”¨çš„diffæ•°æ®
     * 
     * @return æ¨¡æ‹Ÿçš„git diffå†…å®¹
     */
    private String getTestDiffData() {
        return "diff --git a/test.txt b/test.txt\n" +
               "new file mode 100644\n" +
               "index 0000000..e69de29\n" +
               "--- /dev/null\n" +
               "+++ b/test.txt\n" +
               "@@ -0,0 +1 @@\n" +
               "+test content";
    }
}

package com.microsoft;

import com.microsoft.infrastruture.git.GitCommand;
import lombok.extern.slf4j.Slf4j;
import org.junit.Test;
import org.junit.Before;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;

import static org.mockito.Mockito.*;
import static org.junit.Assert.*;

/**
 * Gitæ¨é€åŠŸèƒ½æµ‹è¯•ç±»
 * 
 * @author development-team
 * @create ${CURRENT_DATE}
 * 
 * éªŒè¯ä»£ç è¯„å®¡æ—¥å¿—çš„æ¨é€åŠŸèƒ½ï¼Œä½¿ç”¨mocké¿å…çœŸå®ä»“åº“æ“ä½œ
 */
@Slf4j
public class GitPushFunctionalityTest {

    @Mock
    private GitCommand mockGitCommand;
    
    private static final String TEST_REPOSITORY_URL = "https://github.com/test/repo.git";
    private static final String TEST_TOKEN = "test_token_placeholder";

    @Before
    public void setUp() {
        MockitoAnnotations.initMocks(this);
    }

    @Test(expected = IllegalArgumentException.class)
    public void shouldThrowExceptionWhenRepositoryUrlIsNull() {
        new GitCommand(null, TEST_TOKEN, "main", "author", "project", "message");
    }

    @Test(expected = IllegalArgumentException.class)
    public void shouldThrowExceptionWhenTokenIsNull() {
        new GitCommand(TEST_REPOSITORY_URL, null, "main", "author", "project", "message");
    }

    @Test
    public void shouldSuccessfullyPushWithValidParameters() {
        try {
            // é…ç½®mock
            when(mockGitCommand.commitAndPush(anyString()))
                .thenReturn("https://github.com/test/repo/blob/main/test-file.md");
            
            // æ‰§è¡Œæµ‹è¯•
            String result = mockGitCommand.commitAndPush("test content");
            
            // éªŒè¯ç»“æœ
            assertNotNull("æ¨é€ç»“æœä¸åº”ä¸ºç©º", result);
            assertTrue("ç»“æœåº”åŒ…å«æœ‰æ•ˆURL", result.contains("github.com"));
            
            log.info("æ¨é€æµ‹è¯•é€šè¿‡ï¼Œç»“æœURL: {}", result);
        } catch (Exception e) {
            log.error("æ¨é€æµ‹è¯•å¤±è´¥", e);
            fail("æ¨é€æµ‹è¯•ä¸åº”æŠ›å‡ºå¼‚å¸¸: " + e.getMessage());
        }
    }

    @Test
    public void shouldHandleEmptyContentGracefully() {
        try {
            when(mockGitCommand.commitAndPush(""))
                .thenThrow(new IllegalArgumentException("å†…å®¹ä¸èƒ½ä¸ºç©º"));
            
            mockGitCommand.commitAndPush("");
            fail("åº”æŠ›å‡ºIllegalArgumentException");
        } catch (IllegalArgumentException e) {
            assertEquals("é”™è¯¯æ¶ˆæ¯ä¸åŒ¹é…", "å†…å®¹ä¸èƒ½ä¸ºç©º", e.getMessage());
            log.info("ç©ºå†…å®¹å¤„ç†æµ‹è¯•é€šè¿‡");
        }
    }
}
```
#### ğŸ¤”é—®é¢˜ç‚¹ï¼š
åŸå§‹ä»£ç è™½ç„¶å®ç°äº†åŸºæœ¬åŠŸèƒ½ï¼Œä½†å­˜åœ¨ä¸¥é‡çš„å®‰å…¨éšæ‚£å’Œæµ‹è¯•è®¾è®¡ç¼ºé™·ã€‚ç¡¬ç¼–ç çš„æ•æ„Ÿä¿¡æ¯å¯èƒ½å¯¼è‡´å®‰å…¨æ³„éœ²ï¼Œæµ‹è¯•æ–¹æ³•ç¼ºä¹éš”ç¦»æ€§ï¼Œå¼‚å¸¸å¤„ç†è¿‡äºç²—ç³™ã€‚æ•´ä½“ä»£ç è´¨é‡æœ‰å¾…æå‡ï¼Œéœ€è¦åŠ å¼ºå®‰å…¨æ„è¯†å’Œæµ‹è¯•è§„èŒƒã€‚
#### ğŸ¯ä¿®æ”¹å»ºè®®ï¼š
å»ºè®®å›¢é˜Ÿå»ºç«‹ä»£ç å®‰å…¨æ£€æŸ¥æµç¨‹ï¼Œç¡®ä¿æ•æ„Ÿä¿¡æ¯ä¸è¢«æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ã€‚é‡‡ç”¨æ ‡å‡†çš„å•å…ƒæµ‹è¯•æ¡†æ¶å’ŒmockæŠ€æœ¯ï¼Œæé«˜æµ‹è¯•çš„å¯é æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚åŠ å¼ºå¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œæä¾›æ›´ç²¾ç¡®çš„é”™è¯¯ä¿¡æ¯ã€‚