
# OpenAi ä»£ç è¯„å®¡.
### ğŸ˜€ä»£ç è¯„åˆ†ï¼š75
#### ğŸ˜€ä»£ç é€»è¾‘ä¸ç›®çš„ï¼š
æœ¬æ¬¡ä»£ç å˜æ›´æ—¨åœ¨é‡æ„ä¸€ä¸ªè‡ªåŠ¨åŒ–ä»£ç å®¡æŸ¥å·¥å…·ã€‚å…¶æ ¸å¿ƒé€»è¾‘æ˜¯ï¼šåœ¨æ¯æ¬¡ä»£ç æäº¤åï¼Œé€šè¿‡GitHub Actionsè§¦å‘ï¼Œæ‹‰å–ä»£ç å˜æ›´ï¼Œè°ƒç”¨ChatGLMå¤§æ¨¡å‹è¿›è¡Œæ™ºèƒ½ä»£ç å®¡æŸ¥ï¼Œç„¶åå°†å®¡æŸ¥ç»“æœä»¥Markdownå½¢å¼æäº¤åˆ°ç‹¬ç«‹çš„æ—¥å¿—ä»“åº“ï¼Œå¹¶é€šè¿‡å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯é€šçŸ¥ç›¸å…³äººå‘˜ã€‚æ­¤æ¬¡é‡æ„å°†åŸæœ¬å•ä¸€çš„mainæ–¹æ³•å®ç°ï¼Œæ‹†åˆ†ä¸ºé¢†åŸŸæœåŠ¡å±‚å’ŒåŸºç¡€è®¾æ–½å±‚ï¼Œæå‡äº†ä»£ç çš„æ¨¡å—åŒ–å’Œå¯ç»´æŠ¤æ€§ã€‚
#### âœ…ä»£ç ä¼˜ç‚¹ï¼š
1.  **æ¶æ„æ¸…æ™°**ï¼šå¼•å…¥äº†`IOpenAiCodeReviewService`æ¥å£ã€`AbstractOpenAiCodeReviewService`æŠ½è±¡ç±»å’Œå…·ä½“å®ç°`OpenAICodeReviewService`ï¼Œé‡‡ç”¨äº†æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼ï¼Œä½¿å¾—ä»£ç å®¡æŸ¥æµç¨‹ï¼ˆè·å–å·®å¼‚ã€å®¡æŸ¥ã€è®°å½•ã€é€šçŸ¥ï¼‰éå¸¸æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•ã€‚
2.  **èŒè´£åˆ†ç¦»**ï¼šå°†Gitæ“ä½œã€OpenAI APIè°ƒç”¨ã€å¾®ä¿¡æ¶ˆæ¯æ¨é€ç­‰é€»è¾‘åˆ†åˆ«å°è£…åˆ°`GitCommand`ã€`ChatGLM`ã€`WeiXin`ç­‰ç‹¬ç«‹çš„ç±»ä¸­ï¼Œé™ä½äº†è€¦åˆåº¦ã€‚
3.  **é…ç½®å¤–éƒ¨åŒ–**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡å’ŒGitHub Secretsç®¡ç†æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚Tokenã€API Keyï¼‰ï¼Œé¿å…äº†åœ¨ä»£ç ä¸­ç¡¬ç¼–ç ï¼Œè¿™æ˜¯ä¸€ä¸ªå¥½çš„å®è·µæ–¹å‘ã€‚
#### ğŸ¤”é—®é¢˜ç‚¹ï¼š
1.  **ã€ä¸¥é‡ã€‘å®‰å…¨é£é™©**ï¼š`.idea/ApifoxUploaderProjectSetting.xml`æ–‡ä»¶ä¸­ç›´æ¥æäº¤äº†APIè®¿é—®ä»¤ç‰Œ`APS-Md8LXP1oeZamvjty4e8dZXd9YX0bBYha`ã€‚`WXAccessTokenUtils`ä¸­ç¡¬ç¼–ç äº†`APPID`å’Œ`SECRET`ã€‚**è¿™æ˜¯æå…¶ä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œç­‰åŒäºå°†å¤§é—¨é’¥åŒ™å…¬ä¹‹äºä¼—ï¼Œå¿…é¡»ç«‹å³ä¿®å¤å¹¶åºŸé™¤å·²æš´éœ²çš„ä»¤ç‰Œã€‚**
2.  **ã€ä¸¥é‡ã€‘ä¿¡æ¯æ³„éœ²**ï¼šGitHub Actionså·¥ä½œæµä¸­ï¼Œå°†åŒ…å«æ•æ„Ÿä¿¡æ¯çš„`GITHUB_TOKEN`ã€`COMMIT_AUTHOR`ç­‰ç¯å¢ƒå˜é‡ä½¿ç”¨`echo`æ‰“å°åˆ°æ§åˆ¶å°ã€‚åœ¨CI/CDæ—¥å¿—ä¸­æš´éœ²è¿™äº›ä¿¡æ¯ä¼šå¸¦æ¥å®‰å…¨éšæ‚£ã€‚
3.  **ã€æ€§èƒ½ã€‘æ•ˆç‡ä½ä¸‹**ï¼š
    *   `GitCommand.commitAndPush`æ–¹æ³•æ¯æ¬¡éƒ½å®Œæ•´`clone`æ•´ä¸ªæ—¥å¿—ä»“åº“ï¼Œå¯¹äºå¤§å‹ä»“åº“æˆ–é¢‘ç¹è§¦å‘çš„åœºæ™¯ï¼Œè¿™å°†ä¸¥é‡æ‹–æ…¢CI/CDæµç¨‹ã€‚
    *   `WXAccessTokenUtils.getAccessToken`æ¯æ¬¡è°ƒç”¨éƒ½å»è¯·æ±‚å¾®ä¿¡æœåŠ¡å™¨è·å–AccessTokenï¼Œè€Œå¾®ä¿¡AccessTokenæœ‰è¾ƒé•¿çš„æœ‰æ•ˆæœŸï¼ˆé€šå¸¸2å°æ—¶ï¼‰ï¼Œé¢‘ç¹è¯·æ±‚æ˜¯æµªè´¹èµ„æºä¸”å¯èƒ½è§¦å‘é™æµã€‚
4.  **ã€å¯ç»´æŠ¤æ€§ã€‘ä»£ç è‡ƒè‚¿**ï¼š`OpenAICodeReviewService.codeReview`æ–¹æ³•ä¸­ï¼Œå°†è¶…é•¿çš„Promptç›´æ¥ç¡¬ç¼–ç åœ¨Javaå­—ç¬¦ä¸²é‡Œï¼Œå¯¼è‡´è¯¥ç±»å¯è¯»æ€§æå·®ï¼Œåç»­è‹¥éœ€è°ƒæ•´Promptï¼Œå¿…é¡»é‡æ–°ç¼–è¯‘æ‰“åŒ…ï¼Œéå¸¸ä¸ä¾¿ã€‚
5.  **ã€é€»è¾‘ç¼ºé™·ã€‘è¾¹ç•Œæ¡ä»¶æœªå¤„ç†**ï¼š
    *   `GitCommand.diff`æ–¹æ³•é€šè¿‡`git log -1`è·å–æœ€æ–°commitï¼Œç„¶åç”¨`HEAD^`è¿›è¡Œæ¯”è¾ƒã€‚è¿™åœ¨é¦–æ¬¡æäº¤ï¼ˆæ²¡æœ‰çˆ¶æäº¤ï¼‰æ—¶ä¼šå¤±è´¥ã€‚
    *   `OpenAICodeReview.getEnv`æ–¹æ³•åœ¨ç¯å¢ƒå˜é‡ä¸ºç©ºæ—¶æŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯`value is null`ä¸å¤Ÿå…·ä½“ï¼Œä¸åˆ©äºæ’æŸ¥é—®é¢˜ã€‚
6.  **ã€ä»£ç è§„èŒƒã€‘ä¸è‰¯å®è·µ**ï¼š
    *   ä»£ç ä¸­å……æ–¥ç€`System.out.println`ï¼Œåº”ä½¿ç”¨æ ‡å‡†çš„æ—¥å¿—æ¡†æ¶ï¼ˆå¦‚SLF4Jï¼‰ã€‚
    *   `WeiXin.sendTemplateMessage`ä¸­ä½¿ç”¨`Scanner`è¯»å–HTTPå“åº”ï¼Œä¸è§„èŒƒï¼Œåº”ä½¿ç”¨`BufferedReader`ã€‚
    *   å­˜åœ¨æ‹¼å†™é”™è¯¯`opeai-code-review-sdk`ã€‚
#### ğŸ¯ä¿®æ”¹å»ºè®®ï¼š
1.  **å®‰å…¨ä¼˜å…ˆ**ï¼š
    *   **ç«‹å³åˆ é™¤**`.idea/ApifoxUploaderProjectSetting.xml`æ–‡ä»¶ï¼Œå¹¶å°†è¯¥è·¯å¾„åŠ å…¥`.gitignore`ã€‚
    *   ç«‹å³åœ¨ç›¸å…³å¹³å°ï¼ˆApifoxã€å¾®ä¿¡ï¼‰**åºŸé™¤å·²æš´éœ²çš„Tokenå’ŒSecret**ã€‚
    *   å°†`WXAccessTokenUtils`ä¸­çš„ç¡¬ç¼–ç `APPID`å’Œ`SECRET`æ”¹ä¸ºé€šè¿‡ç¯å¢ƒå˜é‡ä¼ å…¥ã€‚
    *   **åˆ é™¤**GitHub Actionsä¸­æ‰€æœ‰`echo`æ‰“å°æ•æ„Ÿä¿¡æ¯çš„æ­¥éª¤ã€‚
2.  **æ€§èƒ½ä¼˜åŒ–**ï¼š
    *   **æ”¹é€ `GitCommand`**ï¼šåœ¨CIç¯å¢ƒä¸­ï¼Œå¯ä»¥å°†æ—¥å¿—ä»“åº“`clone`åˆ°ä¸€ä¸ªå›ºå®šçš„ç¼“å­˜ç›®å½•ï¼Œåç»­æ‰§è¡Œæ—¶å…ˆ`git pull`æ‹‰å–æœ€æ–°ä»£ç ï¼Œè€Œä¸æ˜¯æ¯æ¬¡é‡æ–°`clone`ã€‚
    *   **æ”¹é€ `WXAccessTokenUtils`**ï¼šå®ç°ä¸€ä¸ªç®€å•çš„å†…å­˜ç¼“å­˜ï¼Œå­˜å‚¨AccessTokenåŠå…¶è¿‡æœŸæ—¶é—´ã€‚åœ¨è·å–Tokenå‰å…ˆæ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆï¼Œæ— æ•ˆå†è¯·æ±‚ã€‚
3.  **æå‡å¯ç»´æŠ¤æ€§**ï¼š
    *   å°†Promptæ–‡æœ¬æŠ½å–åˆ°`src/main/resources/prompt-template.txt`æ–‡ä»¶ä¸­ã€‚
    *   åœ¨`OpenAICodeReviewService`å¯åŠ¨æ—¶è¯»å–è¯¥æ–‡ä»¶å†…å®¹ï¼Œæˆ–åœ¨`codeReview`æ–¹æ³•ä¸­åŠ¨æ€è¯»å–ã€‚
4.  **å¥å£®æ€§å¢å¼º**ï¼š
    *   ä¿®æ”¹`GitCommand.diff`é€»è¾‘ï¼Œå¤„ç†é¦–æ¬¡æäº¤çš„è¾¹ç•Œæƒ…å†µã€‚
    *   å®Œå–„`getEnv`çš„å¼‚å¸¸ä¿¡æ¯ï¼Œæ˜ç¡®æŒ‡å‡ºæ˜¯å“ªä¸ªç¯å¢ƒå˜é‡ç¼ºå¤±ã€‚
5.  **ä»£ç è§„èŒƒåŒ–**ï¼š
    *   å…¨å±€æœç´¢`System.out.println`ï¼Œæ›¿æ¢ä¸º`log.info()`æˆ–`log.debug()`ã€‚
    *   ç»Ÿä¸€ä½¿ç”¨`BufferedReader`å¤„ç†HTTPæµå“åº”ã€‚
    *   ä¿®æ­£æ‹¼å†™é”™è¯¯`opeai`ä¸º`openai`ã€‚
#### ğŸ’»ä¿®æ”¹åçš„ä»£ç ï¼š
`.github/workflows/remote-server.yml` (å…³é”®éƒ¨åˆ†)
```yaml
# ...
      - name: Build openai-code-review-sdk JAR
        run: |
          cd openai-code-review-sdk # ä¿®æ­£æ‹¼å†™
          mvn clean package -DskipTests
          cp target/openai-code-review-sdk-*.jar ../libs/openai-code-review-sdk.jar
          cd ..
# ...
# åˆ é™¤ä»¥ä¸‹æ‰€æœ‰Printæ­¥éª¤
# - name: Print repository, branch name, commit author, and commit message
#   run: | ...
# ...
      - name: Run Code Review
        run: java -jar ./libs/openai-code-review-sdk.jar
        env:
          # ... å…¶ä»–é…ç½®
          # å¾®ä¿¡é…ç½®ï¼Œä»secretsè¯»å–ï¼Œä¸å†ç¡¬ç¼–ç 
          WEIXIN_APPID: ${{ secrets.WEIXIN_APPID }}
          WEIXIN_SECRET: ${{ secrets.WEIXIN_SECRET }}
          # ...
```

`opeai-code-review-sdk/src/main/java/com/microsoft/infrastruture/weixin/WXAccessTokenUtils.java`
```java
// ... åŒ…å¯¼å…¥
import lombok.extern.slf4j.Slf4j;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.TimeUnit;

@Slf4j
public class WXAccessTokenUtils {
    private static final ConcurrentHashMap<String, Token> TOKEN_CACHE = new ConcurrentHashMap<>();

    // ç§»é™¤ç¡¬ç¼–ç çš„APPIDå’ŒSECRET
    // private static final String APPID = "...";
    // private static final String SECRET = "...";
    private static final String GRANT_TYPE = "client_credential";
    private static final String URL_TEMPLATE = "https://api.weixin.qq.com/cgi-bin/token?grant_type=%s&appid=%s&secret=%s";

    public static String getAccessToken(String appId, String secret) {
        String cacheKey = appId + "_" + secret;
        Token cachedToken = TOKEN_CACHE.get(cacheKey);
        
        // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
        if (cachedToken != null && cachedToken.getExpires_in() > System.currentTimeMillis()) {
            log.info("Fetching WeChat Access Token from cache.");
            return cachedToken.getAccess_token();
        }

        log.info("Requesting new WeChat Access Token...");
        try {
            String urlString = String.format(URL_TEMPLATE, GRANT_TYPE, appId, secret);
            URL url = new URL(urlString);
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("GET");

            if (connection.getResponseCode() == HttpURLConnection.HTTP_OK) {
                try (BufferedReader in = new BufferedReader(new InputStreamReader(connection.getInputStream()))) {
                    StringBuilder response = new StringBuilder();
                    String inputLine;
                    while ((inputLine = in.readLine()) != null) {
                        response.append(inputLine);
                    }
                    Token token = JSON.parseObject(response.toString(), Token.class);
                    // ç¼“å­˜tokenï¼Œæå‰5åˆ†é’Ÿè¿‡æœŸ
                    long expiresAt = System.currentTimeMillis() + (token.getExpires_in() - 300) * 1000L;
                    token.setExpires_in(expiresAt);
                    TOKEN_CACHE.put(cacheKey, token);
                    return token.getAccess_token();
                }
            } else {
                log.error("Failed to get WeChat Access Token, response code: {}", connection.getResponseCode());
                throw new RuntimeException("Failed to get WeChat Access Token");
            }
        } catch (Exception e) {
            log.error("Error getting WeChat Access Token", e);
            throw new RuntimeException("Error getting WeChat Access Token", e);
        }
    }

    public static class Token {
        private String access_token;
        // å­—æ®µåæ”¹ä¸ºè¿‡æœŸæ—¶é—´æˆ³
        private long expires_in; 

        // getters and setters...
    }
}
```

`opeai-code-review-sdk/src/main/resources/prompt-template.txt` (æ–°å»ºæ–‡ä»¶)
```
ä½ æ˜¯ä¸€ä½èµ„æ·±ç¼–ç¨‹ä¸“å®¶... (æ­¤å¤„æ”¾å®Œæ•´çš„é•¿Prompt)
...è¿”å›æ ¼å¼ä¸¥æ ¼å¦‚ä¸‹ï¼š
# OpenAi ä»£ç è¯„å®¡.
...
`;ä»£ç å¦‚ä¸‹:
```

`opeai-code-review-sdk/src/main/java/com/microsoft/domain/service/impl/OpenAICodeReviewService.java` (å…³é”®éƒ¨åˆ†)
```java
// ...
import org.springframework.core.io.ClassPathResource;
// ...

public class OpenAICodeReviewService extends AbstractOpenAiCodeReviewService {
    // ... constructor
    
    private final String promptTemplate;

    public OpenAICodeReviewService(IOpenAI iOpenAI, GitCommand gitCommand, WeiXin weiXin) throws IOException {
        super(iOpenAI, gitCommand, weiXin);
        // åœ¨æ„é€ å‡½æ•°ä¸­åŠ è½½Prompt
        this.promptTemplate = loadPromptTemplate();
    }

    private String loadPromptTemplate() throws IOException {
        ClassPathResource resource = new ClassPathResource("prompt-template.txt");
        try (BufferedReader reader = new BufferedReader(new InputStreamReader(resource.getInputStream()))) {
            StringBuilder sb = new StringBuilder();
            String line;
            while ((line = reader.readLine()) != null) {
                sb.append(line).append("\n");
            }
            return sb.toString();
        }
    }

    @Override
    protected String codeReview(String diffCode) throws Exception {
        ChatCompletionRequestDTO chatCompletionRequest = new ChatCompletionRequestDTO();
        chatCompletionRequest.setModel(Model.GLM_4_6.getCode());
        chatCompletionRequest.setMessages(new ArrayList<>() {{
            add(new ChatCompletionRequestDTO.Prompt("user", promptTemplate)); // ä½¿ç”¨åŠ è½½çš„æ¨¡æ¿
            add(new ChatCompletionRequestDTO.Prompt("user", diffCode));
        }});
        // ... åç»­é€»è¾‘ä¸å˜
    }
    // ... å…¶ä»–æ–¹æ³•
}
```